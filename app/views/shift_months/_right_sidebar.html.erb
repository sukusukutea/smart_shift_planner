<% active_tab = params[:tab] == "daily" ? "daily" : "holiday" %>
<div class="h-100 d-flex flex-column" style="background-color: #e6f0f0;">
  <!-- 切り替えボタン -->
  <div class="d-flex justify-content-around px-1 py-1 border-bottom">
    <button class="btn btn-outline-secondary w-100 <%= active_tab == "holiday" ? "active" : "" %>"
            id="btn-holiday" onclick="showTab('holiday')">休日設定</button>
    <button class="btn btn-outline-secondary w-100 <%= active_tab == "daily" ? "active" : "" %>"
            id="btn-daily" onclick="showTab('daily')">日別調整</button>
  </div>

  <!-- コンテンツ -->
  <div class="flex-grow-1 px-3 pt-3" id="tab-content-area">
    <div id="tab-holiday" style="<%= active_tab == "holiday" ? "" : "display:none;" %>">

      <%= form_with model: @shift_month,
                    url: update_settings_shift_month_path(@shift_month),
                    method: :patch,
                    local: true do |f| %>

        <div class="mb-3">
          <p class="fw-bold small">今月の休日日数</p>
          <label class="form-label small">全職員共通</label>
          <div class="d-flex justify align-items-center">
            <%= f.number_field :holiday_days,
                               min: 0,
                               max: 31,
                               class: "form-control form-control-sm w-auto me-1" %>
            <span class="small">日</span>
            <div class="ms-3">
              <%= f.submit "登録", class: "btn btn-sm btn-light border" %>
            </div>
          </div>
        </div>
      <% end %>

      <hr class="my-3">

      <div class="mb-2">
        <p class="fw-bold small mb-2">職員の休日希望</p>

        <%= form_with url: settings_shift_month_path(@shift_month),
                      method: :get,
                      local: true do %>
          <%= hidden_field_tag :tab, "holiday" %>

          <div class="d-flex gap-2 align-items-end">
            <div class="flex-grow-1">
              <%= select_tag :staff_id,
                  options_for_select(
                    @all_staffs.map { |staff| ["#{staff.last_name} #{staff.first_name}", staff.id] },
                    @selected_staff&.id
                  ),
                  include_blank: "職員を選択",
                  class: "form-select form-select-sm" %>
            </div>
            <div>
              <%= submit_tag "表示", class:"btn btn-sm btn-light border" %>
            </div>
          </div>
        <% end %>

        <% if @selected_staff %>
          <%= form_with url: add_staff_holiday_shift_month_path(@shift_month),
                        method: :post,
                        local: true do %>
            <%= hidden_field_tag :staff_id, @selected_staff.id %>

            <div class="mt-3">
              <label class="form-label small">休日設定</label>
              <div class="d-flex gap-2 align-items-end">
                <div class="flex-grow-1">
                  <%= date_field_tag :date,
                        @month_begin.iso8601,
                        min: @month_begin.iso8601,
                        max: @month_end.iso8601,
                        class: "form-control form-control-sm" %>
                </div>
                <div>
                  <%= submit_tag "+追加", class: "btn btn-sm btn-light border" %>
                </div>
              </div>
            </div>
          <% end %>

          <div class="mt-3">
            <div class="small text-muted mb-1">指定済み</div>

            <% if @selected_staff_holidays.any? %>
              <ul class="list-unstyled small">
                <% @selected_staff_holidays.each do |request| %>
                  <li class="d-flex justify-content-between align-items-center mb-1">
                    <span><%= request.date.strftime("%-m/%-d") %></span>

                    <%= button_to "削除",
                                  remove_staff_holiday_shift_month_path(@shift_month, request_id: request.id),
                                  method: :delete,
                                  class: "btn btn-sm btn-outline-danger py-0 px-2",
                                  form_class: "m-0" %>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <div class="small text-muted">まだ指定がありません</div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <div id="tab-daily" style="<%= active_tab == "daily" ? "" : "display: none;" %>">

      <div class="mb-3">
        <p class="fw-bold small mb-2">日付を選択</p>

        <%= form_with url: settings_shift_month_path(@shift_month),
                      method: :get,
                      local: true do %>
          <%= hidden_field_tag :tab, "daily" %>

          <div class="d-flex align-items-end gap-2">
            <div>
              <%= date_field_tag :date,
                                @selected_date&.iso8601,
                                min: @month_begin.iso8601,
                                max: @month_end.iso8601,
                                class: "form-control form-control-sm" %>
            </div>
            <div>
              <%= submit_tag "表示",
                            class: "btn btn-sm btn-light border mt-2" %>
            </div>
          </div>
        <% end %>
      </div>

      <hr class="my-3">

      <%= form_with url: update_daily_shift_month_path(@shift_month),
                    method: :patch,
                    local: true,
                    data: { controller: "daily" } do %>

        <%= hidden_field_tag :tab, "daily" %>
        <%= hidden_field_tag :date, @selected_date.iso8601 %>

        <div class="mb-2">
          <p class="fw-bold small mb-2">
            勤務形態(<%= @selected_date.strftime("%Y年%-m月%-d日") %>)
          </p>

          <% ShiftMonth::SHIFT_KINDS.each do |kind| %>
            <% label =
              case kind
              when :day    then "日勤"
              when :early  then "早番"
              when :late   then "遅番"
              when :night  then "夜勤"
              else kind.to_s
              end
            %>

            <div class="mb-2">
              <div class="d-flex align-items-center small mb-1">
                <span class="me-3"><%= label %></span>


                <div class="d-flex align-items-center gap-3 ms-1">
                  <%= hidden_field_tag "day_setting[enabled][#{kind}]", 0 %>
                  <div class="form-check form-switch m-0">
                    <%= check_box_tag "day_setting[enabled][#{kind}]",
                                      1,
                                      @enabled_map[kind] == true,
                                      class: "form-check-input",
                                      data: (kind == :day ? { action: "change->daily#toggleDayReq" } : {}) %>
                  </div>
                </div>
              </div>

              <% if kind == :day %>
                <% day_enabled = (@enabled_map[:day] == true) %>

                <div class="mt-1"
                    data-daily-target="dayReq"
                    style="<%= day_enabled ? "" : "display:none;" %>">

                  <div class="d-flex flex-column gap-1" style="white-space: nowrap;">
                    <div class="d-flex align-items-center flex-nowrap gap-1">
                      <span class="text-muted" style="font-size: 12px; line-height: 1;">看護</span>
                      <%= number_field_tag "day_requirements[roles][nurse]",
                                          @day_req[:nurse],
                                          min: 0,
                                          class: "form-control form-control-sm text-center py-0 px-1",
                                          style: "width:44px; height:25px; min-height:25px; padding-top:0; padding-bottom:0; line-height:1; font-size:13px; box-sizing:border-box;" %>

                      <span class="text-muted ms-1" style="font-size: 12px; line-height: 1;">介護</span>
                      <%= number_field_tag "day_requirements[roles][care]",
                                          @day_req[:care],
                                          min: 0,
                                          class: "form-control form-control-sm text-center py-0 px-1",
                                          style: "width:44px; height:25px; min-height:25px; padding-top:0; padding-bottom:0; line-height:1; font-size:13px; box-sizing:border-box;" %>
                    </div>
                    <div class="d-flex align-items-center flex-nowrap gap-1">
                      <span class="text-muted" style="font-size: 12px; line-height: 1;">運転</span>
                      <%= number_field_tag "day_requirements[skills][drive]",
                                            @day_skill_req[:drive],
                                            min: 0,
                                            class: "form-control form-control-sm text-center py-0 px-1",
                                            style: "width:44px; height:25px; min-height:25px; padding-top:0; padding-bottom:0; line-height:1; font-size:13px; box-sizing:border-box;" %>

                      <span class="text-muted ms-1" style="font-size: 12px; line-height: 1;">調理</span>
                      <%= number_field_tag "day_requirements[skills][cook]",
                                            @day_skill_req[:cook],
                                            min: 0,
                                            class: "form-control form-control-sm text-center py-0 px-1",
                                            style: "width:44px; height:25px; min-height:25px; padding-top:0; padding-bottom:0; line-height:1; font-size:13px; box-sizing:border-box;" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <div class="d-flex justify-content-between mt-3">
            <%= link_to "キャンセル",
                        settings_shift_month_path(@shift_month, tab: "daily", date: @selected_date.iso8601),
                        class: "btn btn-sm btn-light border" %>
            <%= submit_tag "保存",
                          class: "btn btn-sm btn-light border" %>
          </div>
        </div>
      <% end %>

      <hr class="my-3">
      <p class="fw-bold small mb-3">出勤者指定(<%= @selected_date.strftime("%Y年%-m月%-d日") %>)</p>

      <%# 職員選択(GETで表示を切り替える) %>
      <%= form_with url: settings_shift_month_path(@shift_month),
                         method: :get,
                         local: true do %>
        <%= hidden_field_tag :tab, "daily" %>
        <%= hidden_field_tag :date, @selected_date.iso8601 %>

        <div class="d-flex gap-2 align-items-end">
          <div class="flex-grow-1">
            <%= select_tag :designation_staff_id,
                options_for_select(
                  @all_staffs.map { |s| ["#{s.last_name} #{s.first_name}", s.id] },
                  @selected_designation_staff&.id
                ),
                include_blank: "職員を選択",
                class: "form-select form-select-sm" %>
          </div>
          <div>
           <%= submit_tag "表示", class: "btn btn-sm btn-light border" %>
          </div>
        </div>
      <% end %>

      <%# ② 職員が選ばれたら、勤務形態フォーム + 一覧を表示 %>
      <% if @selected_designation_staff %>
        <%= form_with url: update_designation_shift_month_path(@shift_month),
                      method: :post,
                      local: true do %>
          <%= hidden_field_tag :date, @selected_date.iso8601 %>
          <%= hidden_field_tag "designation[staff_id]", @selected_designation_staff.id %>

          <div class="mt-3">
            <div class="d-flex gap-2 align-items-end">
              <div class="flex-grow-1">
                <%= select_tag "designation[shift_kind]",
                    options_for_select([["日勤","day"], ["早番","early"], ["遅番","late"], ["夜勤","night"]]),
                    include_blank: "勤務を選択",
                    class: "form-select form-select-sm" %>
              </div>
              <div>
                <%= submit_tag "+追加/更新", class: "btn btn-sm btn-light border" %>
              </div>
            </div>
          </div>
        <% end %>

        <div class="mt-3">
          <div class="small text-muted mb-1">指定済み</div>

          <% if @designations_for_staff.any? %>
            <ul class="list-unstyled small">
              <% @designations_for_staff.each do |d| %>
                <% label =
                  case d.shift_kind.to_s
                  when "day"   then "日勤"
                  when "early" then "早番"
                  when "late"  then "遅番"
                  when "night" then "夜勤"
                  else d.shift_kind.to_s
                  end
                %>
                <li class="d-flex justify-content-between align-items-center mb-1">
                  <span><%= d.date.strftime("%-m/%-d") %> <%= label %></span>

                  <%= button_to "削除",
                        remove_designation_shift_month_path(
                          @shift_month,
                          designation_id: d.id,
                          date: @selected_date.iso8601
                        ),
                        method: :delete,
                        class: "btn btn-sm btn-outline-danger py-0 px-2",
                        form_class: "m-0",
                        params: { tab: "daily", designation_staff_id: @selected_designation_staff.id } %>
                </li>
              <% end %>
            </ul>
          <% else %>
            <div class="small text-muted">まだ指定がありません</div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function showTab(tabName) {
    document.getElementById("tab-holiday").style.display = tabName === "holiday" ? "block" : "none";
    document.getElementById("tab-daily").style.display = tabName === "daily" ? "block" : "none";

    document.getElementById("btn-holiday").classList.toggle("active", tabName === "holiday");
    document.getElementById("btn-daily").classList.toggle("active", tabName === "daily");
  }
</script>