<%# locals:
  date:, in_month:, occupation:, row_key:, shift_month:,
  day_enabled_by_date:, early_enabled_by_date:, late_enabled_by_date:,
  required_by_date:, required_skill_by_date:, saved:, staff_by_id:,
  alerts_by_date:, unassigned_display_staffs_by_date:, holiday_requests_by_date, designations_by_date
%>

<% ctx = shift_day_context(saved, date) %>
<% day_rows   = ctx[:day_rows] %>
<% early_rows = ctx[:early_rows] %>
<% late_rows  = ctx[:late_rows] %>
<% night_rows = ctx[:night_rows] %>
<% night_sid  = ctx[:night_sid] %>
<% night_off_sid = ctx[:night_off_sid] %>
<% night_related_ids = ctx[:night_related_ids] %>

<% if row_key == :req %>
  <%= render "shift_months/calendar_cells/req",
             date: date,
             shift_month: shift_month,
             day_enabled_by_date: day_enabled_by_date,
             required_by_date: required_by_date,
             early_enabled_by_date: early_enabled_by_date,
             late_enabled_by_date: late_enabled_by_date,
             required_skill_by_date: required_skill_by_date %>
<% elsif row_key == :alert %>
  <% base_msgs = Array(alerts_by_date[date]) %>
  <% msgs = augment_alert_messages_for_night_conflicts(
              base_msgs: base_msgs,
              draft: saved,
              date: date,
              holiday_requests_by_date: holiday_requests_by_date,
              designations_by_date: designations_by_date
            ) %>

  <% if msgs.any? %>
    <div class="d-flex flex-wrap gap-1 small">
      <% msgs.each do |msg| %>
        <% badge_class = alert_badge_class(msg) %>
        <span class="badge rounded-pill <%= badge_class %>"><%= msg %></span>
      <% end %>
    </div>
  <% else %>
    <div class="text-muted small">-</div>
  <% end %>
<% else %>
  <div class="day-slots">
    <div class="slot slot-day">
    <% if row_key == :care && in_month %>
      <%# 介護だけ：固定順名簿で「勤務 or 休み」を表示 %>
      <% care_staffs =
           staff_by_id.values
                      .select { |s| s && row_key_for(s) == :care }
                      .sort_by do |s|
                        [
                          s.workday_constraint == "free" ? 0 : 1,
                          s.last_name_kana.to_s,
                          s.first_name_kana.to_s,
                          s.id.to_i
                        ]
                      end %>

      <% assigned_kind_by_id = {} %>
      <% assigned_day_time_option_id_by_id = {} %>

      <% { day: day_rows, early: early_rows, late: late_rows }.each do |kind_sym, rows| %>
        <% Array(rows).each do |r| %>
          <% sid = (r["staff_id"] || r[:staff_id]).to_i %>
          <% next unless sid > 0 %>

          <% assigned_kind_by_id[sid] = kind_sym %>

          <% if kind_sym == :day %>
            <% opt_id = (r["staff_day_time_option_id"] || r[:staff_day_time_option_id]).to_i %>
            <% assigned_day_time_option_id_by_id[sid] = (opt_id > 0 ? opt_id : nil) %>
          <% end %>
        <% end %>
      <% end %>

      <% care_staffs.each do |s| %>
        <% kind = assigned_kind_by_id[s.id] %>
        <% if kind == :early %>
          <div class="small shift-line"><%= s.last_name %><span class="shift-time">730-1630</span></div>
        <% elsif kind == :late %>
          <div class="small shift-line"><%= s.last_name %><span class="shift-time">11-20</span></div>
        <% elsif kind == :day %>
          <% day_opts = Array(s.staff_day_time_options).select { |o| o.active? }.sort_by { |o| [o.position.to_i, o.id.to_i] } %>
          <% day_default = day_opts.find { |o| o.is_default? } || day_opts.first %>
          <% picked_id = assigned_day_time_option_id_by_id[s.id] || day_default&.id %>
          <% picked = picked_id.present? ? day_opts.find { |o| o.id.to_i == picked_id.to_i } : nil %>
          <% t = picked&.time_text.to_s %>

          <% if t.present? %>
            <div class="small shift-line"><%= s.last_name %><span class="shift-time"><%= t %></span></div>
          <% else %>
            <div class="small"><%= s.last_name %></div>
          <% end %>
        <% else %>
          <% if night_related_ids.include?(s.id.to_i) %>
            <div class="small text-danger"><%= s.last_name %></div>
          <% else %>
            <div class="small text-danger"><%= s.last_name %>(休)</div>
          <% end %>
        <% end %>
      <% end %>
    <% else %>
      <%# 介護以外：現行の表示（割当のみ） %>
      <% day_rows.each do |row| %>
        <% sid = (row["staff_id"] || row[:staff_id]).to_i %>
        <% staff = staff_by_id[sid] %>
        <% next if staff.nil? %>
        <% next unless row_key_for(staff) == row_key %>

        <% opt_id = (row["staff_day_time_option_id"] || row[:staff_day_time_option_id]).to_i %>
        <% day_opts = Array(staff.staff_day_time_options).select { |o| o.active? }.sort_by { |o| [o.position.to_i, o.id.to_i] } %>
        <% day_default = day_opts.find { |o| o.is_default? } || day_opts.first %>
        <% picked_id = (opt_id > 0 ? opt_id : nil) || day_default&.id %>
        <% picked = picked_id.present? ? day_opts.find { |o| o.id.to_i == picked_id.to_i } : nil %>
        <% t = picked&.time_text.to_s %>

        <% if t.present? %>
          <div class="small shift-line"><%= staff.last_name %><span class="shift-time"><%= t %></span></div>
        <% else %>
          <div class="small"><%= staff.last_name %></div>
        <% end %>
      <% end %>

      <%# --- 夜勤関連（夜勤入り/明け等）は日勤側に「赤字で名前だけ」出す（介護と同じ挙動）--- %>
      <% displayed_ids = [] %>

      <% day_rows.each do |row| %>
        <% sid = (row["staff_id"] || row[:staff_id]).to_i %>
        <% displayed_ids << sid if sid > 0 %>
      <% end %>
      <% early_rows.each do |row| %>
        <% sid = (row["staff_id"] || row[:staff_id]).to_i %>
        <% displayed_ids << sid if sid > 0 %>
      <% end %>
      <% late_rows.each do |row| %>
        <% sid = (row["staff_id"] || row[:staff_id]).to_i %>
        <% displayed_ids << sid if sid > 0 %>
      <% end %>

      <% Array(night_related_ids).each do |sid| %>
        <% sid = sid.to_i %>
        <% next if sid <= 0 %>
        <% next if displayed_ids.include?(sid) %>

        <% staff = staff_by_id[sid] %>
        <% next if staff.nil? %>
        <% next if staff.respond_to?(:active?) && !staff.active? %>
        <% next unless row_key_for(staff) == row_key %>

        <div class="small text-danger"><%= staff.last_name %></div>
      <% end %>

      <%# 未割当(休み)表示：その月だけ %>
      <% if in_month %>
        <% unassigned_staffs = (unassigned_display_staffs_by_date && unassigned_display_staffs_by_date[date]) || [] %>
        <% unassigned_staffs.each do |staff| %>
          <% next if staff.nil? %>
          <% next unless row_key_for(staff) == row_key %>

          <% if night_related_ids.include?(staff.id.to_i) %>
            <div class="small text-danger"><%= staff.last_name %></div>
          <% else %>
            <div class="small text-danger"><%= staff.last_name %>(休)</div>
          <% end %>
        <% end %>
      <% end %>
    <% end %>

    <% if !(row_key == :care && in_month) %>
      <% early_rows.each do |row| %>
        <% staff = staff_by_id[row["staff_id"]] %>
        <% next if staff.nil? %>
        <% if row_key_for(staff) == row_key %>
          <div class="small shift-line">
            <%= staff.last_name %><span class="shift-time">730-1630</span>
          </div>
        <% end %>
      <% end %>

      <% late_rows.each do |row| %>
        <% staff = staff_by_id[row["staff_id"]] %>
        <% next if staff.nil? %>
        <% if row_key_for(staff) == row_key %>
          <div class="small shift-line">
            <%= staff.last_name %><span class="shift-time">11-20</span>
          </div>
        <% end %>
      <% end %>
    <% end %>
    </div>

    <div class="slot slot-night">
      <%# 夜勤入り（当日） %>
      <% night_rows.each do |row| %>
        <% sid = (row["staff_id"] || row[:staff_id]).to_i %>
        <% staff = staff_by_id[sid] %>
        <% next if staff.nil? %>
        <% if row_key_for(staff) == row_key %>
          <div class="small"><%= staff.last_name %></div>
        <% end %>
      <% end %>

      <%# 明け（前日夜勤者） %>
      <% if night_off_sid.to_i > 0 && night_off_sid.to_i != night_sid.to_i %>
        <% off_staff = staff_by_id[night_off_sid.to_i] %>
        <% if off_staff && row_key_for(off_staff) == row_key %>
          <div class="small"><%= off_staff.last_name %>(明け)</div>
        <% end %>
      <% end %>
    </div>

    <div class="slot slot-stay"></div>
  </div>
<% end %>
