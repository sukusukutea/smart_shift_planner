<%# locals:
  date:, in_month:, row_key:, shift_month:,
  day_enabled_by_date:, early_enabled_by_date:, late_enabled_by_date:,
  required_by_date:, required_skill_by_date:, alerts_by_date:,
  draft:, staff_by_id:, unassigned_display_staffs_by_date:,
  holiday_requests_by_date:, designations_by_date:
%>

<% ctx = shift_day_context(draft, date) %>
<% day_rows   = ctx[:day_rows] %>
<% early_rows = ctx[:early_rows] %>
<% late_rows  = ctx[:late_rows] %>
<% night_related_ids = ctx[:night_related_ids] %>

<% editable_row_keys = %i[nurse care care_mgr cook clerk] %>
<% if editable_row_keys.include?(row_key) && in_month %>
  <%# 介護/ケアマネ/調理/事務：固定順名簿で「勤務 or 休み」を表示 %>
  <% staffs_for_row = sorted_staffs_for_row(staff_by_id: staff_by_id, row_key: row_key) %>

  <% assigned_kind_by_id = {} %>
  <% assigned_day_time_option_id_by_id = {} %>

  <% { day: day_rows, early: early_rows, late: late_rows }.each do |kind_sym, rows| %>
    <% Array(rows).each do |r| %>
      <% sid = (r["staff_id"] || r[:staff_id]).to_i %>
      <% next unless sid > 0 %>

      <% assigned_kind_by_id[sid] = kind_sym %>

      <% if kind_sym == :day %>
        <% opt_id = (r["staff_day_time_option_id"] || r[:staff_day_time_option_id]).to_i %>
        <% assigned_day_time_option_id_by_id[sid] = (opt_id > 0 ? opt_id : nil) %>
      <% end %>
    <% end %>
  <% end %>

  <% staffs_for_row.each do |s| %>
    <% kind = assigned_kind_by_id[s.id] %>
    <% night_related = night_related_ids.map(&:to_i).include?(s.id) %>
    <% day_opts = Array(s.staff_day_time_options).select { |o| o.active? }.sort_by { |o| [o.position.to_i, o.id.to_i] } %>
    <% day_default = day_opts.find { |o| o.is_default? } %>

    <% selected =
      if kind == :day
        picked_id = assigned_day_time_option_id_by_id[s.id] || day_default&.id
        picked_id.present? ? "day:#{picked_id}" : "day"
      elsif kind == :early
        "early"
      elsif kind == :late
        "late"
      else
        night_related ? "night_related" : "off"
      end
    %>

    <% time_text =
      if selected == "early"
        "(730-1630)"
      elsif selected == "late"
        "(11-20)"
      elsif selected.to_s.start_with?("day:")
        picked_id = selected.split(":")[1].to_i
        picked = day_opts.find { |o| o.id.to_i == picked_id }
        picked&.time_text.present? ? "(#{picked.time_text})" : ""
      else
        ""
      end %>

    <% off_text =
        if selected == "off"
          "(休)"
        else
          ""
        end %>
    <% night_related_class = (selected == "night_related") ? "text-danger" : "" %>

    <div class="shift-edit-row" data-controller="shift-edit">
      <div class="shift-edit-display <%= (selected == "off") ? "is-off" : "" %>">
        <span class="shift-edit-name <%= night_related_class %>"><%= s.last_name %><%= off_text %></span>
        <% if time_text.present? %>
          <span class="shift-edit-time"><%= time_text %></span>
        <% end %>
      </div>

      <% unless selected == "night_related" %>
        <select
          class="form-select form-select-sm shift-edit-select"
          data-action="change->shift-edit#change"
          data-staff-id="<%= s.id %>"
          data-staff-name="<%= s.last_name %>"
          data-update-url="<%= update_draft_assignment_shift_month_path(shift_month) %>"
          data-date="<%= date.iso8601 %>"
          data-occupation="<%= row_key %>">

          <option value="day" <%= "selected" if selected == "day" %>>
            <%= s.last_name %>
          </option>

          <% day_opts.each do |opt| %>
            <% v = "day:#{opt.id}" %>
            <option
              value="<%= v %>"
              data-time-text="<%= opt.time_text %>"
              <%= "selected" if selected == v %>>
              <%= s.last_name %>(<%= opt.time_text %>)
            </option>
          <% end %>

          <option value="early" data-time-text="730-1630" <%= "selected" if selected == "early" %>>
            <%= s.last_name %>(730-1630)
          </option>

          <option value="late" data-time-text="11-20" <%= "selected" if selected == "late" %>>
            <%= s.last_name %>(11-20)
          </option>

          <option value="off" <%= "selected" if selected == "off" %>>
            <%= s.last_name %>(休)
          </option>
        </select>
      <% end %>
    </div>
  <% end %>
<% else %>
  <%# 介護以外：現行の表示（割当のみ） %>
  <% day_rows.each do |row| %>
    <% sid = (row["staff_id"] || row[:staff_id]).to_i %>
    <% staff = staff_by_id[sid] %>
    <% next if staff.nil? || !staff.active? %>
    <% if row_key_for(staff) == row_key %>
      <div class="small"><%= staff.last_name %></div>
    <% end %>
  <% end %>

  <%# 未割当(休み)表示：その月だけ %>
  <% if in_month %>
    <% unassigned_staffs = (unassigned_display_staffs_by_date && unassigned_display_staffs_by_date[date]) || [] %>
    <% unassigned_staffs.each do |staff| %>
      <% next if staff.nil? || !staff.active? %>
      <% next if night_related_ids.include?(staff.id.to_i) %>
      <% next unless row_key_for(staff) == row_key %>
      <div class="small text-danger"><%= staff.last_name %>(休)</div>
    <% end %>
  <% end %>
<% end %>

<% if !(editable_row_keys.include?(row_key) && in_month) %>
  <% early_rows.each do |row| %>
    <% sid = (row["staff_id"] || row[:staff_id]).to_i %>
    <% staff = staff_by_id[sid] %>
    <% next if staff.nil? %>
    <% if row_key_for(staff) == row_key %>
      <div class="small shift-line">
        <%= staff.last_name %><span class="shift-time">730-1630</span>
      </div>
    <% end %>
  <% end %>

  <% late_rows.each do |row| %>
    <% sid = (row["staff_id"] || row[:staff_id]).to_i %>
    <% staff = staff_by_id[sid] %>
    <% next if staff.nil? %>
    <% if row_key_for(staff) == row_key %>
      <div class="small shift-line">
        <%= staff.last_name %><span class="shift-time">11-20</span>
      </div>
    <% end %>
  <% end %>
<% end %>
