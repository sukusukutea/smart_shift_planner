<div class="container-fluid">
  <div class="row min-vh-100">
    <div id="sidebar-col" class="col-md-2 col-lg-2 p-0 bg-light border-end">
      <%= render "layouts/sidebar" %>
    </div>

    <div id="main-content" class="col-md-8 col-lg-8 p-4 overflow-auto">
      <div class="d-flex align-items-center gap-2 mb-3" data-controller="left-sidebar">
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="left-sidebar#toggle">
          <i class="bi bi-layout-sidebar-inset"></i>
        </button>

        <%= link_to "戻る", settings_shift_month_path(@shift_month), class:"btn btn-sm btn-light border" %>
        <%= button_to "保存（確定）", confirm_draft_shift_month_path(@shift_month), method: :post, class: "btn btn-sm btn-secondary" %>
      </div>

      <div class="shift-calendar"
           data-controller="drag-scroll"
           data-action="mousedown->drag-scroll#down mousemove->drag-scroll#move mouseup->drag-scroll#up mouseleave->drag-scroll#leave">

        <table class="shift-calendar-month">
          <colgroup>
            <col class="col-occupation">
            <% 7.times do %>
              <col class="col-day">
            <% end %>
          </colgroup>

          <%# 曜日は一番上だけ %>
          <thead>
            <tr>
              <th class="occ-name"></th>
              <% %w[月 火 水 木 金 土 日].each_with_index do |w, i| %>
                <% weekend_class = (i == 5 ? "is-sat" : (i == 6 ? "is-sun" : "")) %>
                <th class="weekday <%= weekend_class %>"><%= w %></th>
              <% end %>
            </tr>
          </thead>

          <tbody>
            <%# 週ごとに「日付+勤務形態ヘッダー」→「職種5行」を繰り返す %>
            <% @weeks.each do |week| %>

              <%# 週ヘッダー（日付＋勤務形態） %>
              <tr class="week-head-row">
                <td class="occ-name"></td>
                <% week.each_with_index do |date, i| %>
                  <% in_month = (date.month == @shift_month.month) %>
                  <% weekend_class = (i == 5 ? "is-sat" : (i == 6 ? "is-sun" : "")) %>
                  <% holiday = @holiday_by_date[date] %>
                  <% is_holiday = holiday.present? %>

                  <td class="day-head <%= weekend_class %> <%= in_month ? "" : "is-out" %> <%= "is-holiday" if is_holiday %>">
                    <div class="day-date <%= 'is-holiday' if is_holiday %>">
                      <%= date.month %>月<%= date.day %>日
                      <% if is_holiday %>
                        <span class="holiday-name"><%= holiday.name %></span>
                      <% end %>
                    </div>

                    <div class="day-kinds">
                      <div class="kcell">日勤</div>
                      <div class="kcell">夜勤</div>
                      <div class="kcell">宿直</div>
                    </div>
                  </td>
                <% end %>
              </tr>

              <%# 職種行（draftの名前を表示） %>
              <% @occupation_order.each do |occupation| %>
                <% row_key = occupation[:key] %>

                <tr class="<%= occupation[:row_class] %>">
                  <th class="occ-name"><%= occupation[:label] %></th>

                  <% week.each do |date| %>
                    <% in_month = (date.month == @shift_month.month) %>
                    <% day_hash = @draft[date.iso8601] || {} %>
                    <% day_rows = day_hash["day"]     || [] %>
                    <% early_rows = day_hash["early"] || [] %>
                    <% late_rows  = day_hash["late"]  || [] %>
                    <% night_rows = day_hash["night"] || [] %>

                    <td class="day-cell <%= in_month ? "" : "is-out" %>">
                      <% if row_key == :req %>
                        <% day_on = @day_enabled_by_date[date] %>

                        <% if day_on %>
                          <% req = @required_by_date[date] || { nurse: 0, care: 0 } %>
                          <div class="req-count text-muted">
                            日勤 看護:<%= req[:nurse] %> 介護:<%= req[:care] %>
                          </div>
                        <% else %>
                          <div class="req-count text-muted">
                            日勤 -
                          </div>
                        <% end %>

                      <% else %>
                        <div class="day-slots">

                          <%# 日勤列：3段 %>
                          <div class="slot slot-day">
                            <% day_rows.each do |row| %>
                              <% staff = @staff_by_id[row["staff_id"]] %>
                              <% next if staff.nil? %>
                              <% if row_key_for(staff) == row_key %>
                                <div class="small"><%= staff.last_name %></div>
                              <% end %>
                            <% end %>

                            <% early_rows.each do |row| %>
                              <% staff = @staff_by_id[row["staff_id"]] %>
                              <% next if staff.nil? %>
                              <% if row_key_for(staff) == row_key %>
                                <div class="small shift-line">
                                  <%= staff.last_name %><span class="shift-time">730-1630</span>
                                </div>
                              <% end %>
                            <% end %>

                            <% late_rows.each do |row| %>
                              <% staff = @staff_by_id[row["staff_id"]] %>
                              <% next if staff.nil? %>
                              <% if row_key_for(staff) == row_key %>
                                <div class="small shift-line">
                                  <%= staff.last_name %><span class="shift-time">11-20</span>
                                </div>
                              <% end %>
                            <% end %>
                          </div>

                          <div class="slot slot-night">
                            <% night_rows.each do |row| %>
                              <% staff = @staff_by_id[row["staff_id"]] %>
                              <% next if staff.nil? %>
                              <% if row_key_for(staff) == row_key %>
                                <div class="small"><%= staff.last_name %></div>
                              <% end %>
                            <% end %>
                          </div>

                          <div class="slot slot-stay"></div>
                        </div>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>

            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <div id="right-sidebar-col" class="col-md-2 col-lg-2 p-0 bg-light border-start">
      <%= render "shift_months/draft_sidebar", stats_rows: @stats_rows %>
    </div>
  </div>
</div>
