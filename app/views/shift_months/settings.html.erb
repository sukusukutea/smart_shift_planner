<div class="container-fluid">
  <div class="row min-vh-100">
    <div id="sidebar-col" class="col-md-2 col-lg-2 p-0 bg-light border-end">
      <%= render "layouts/sidebar" %>
    </div>

    <div id="main-content" class="col-md-8 col-lg-8 p-4 overflow-auto">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <%= button_to "シフト案を作成",
                        generate_draft_shift_month_path(@shift_month),
                        method: :post,
                        class: "btn btn-sm btn-secondary" %>
        </div>

        <div class="fw-bold">
          今月の休日日数：
          <% if@shift_month.holiday_days.present? %>
            <span class="text-danger"><%= @shift_month.holiday_days %>日</span>
          <% else %>
            <span class="text-muted">未設定</span>
          <% end %>
        </div>
      </div>

      <div class="shift-calendar"
           data-controller="drag-scroll"
           data-action="mousedown->drag-scroll#down mousemove->drag-scroll#move mouseup->drag-scroll#up mouseleave->drag-scroll#leave">
        <table class="shift-calendar-month">
          <colgroup>
            <col class="col-occupation">
            <% 7.times do %>
              <col class="col-day">
            <% end %>
          </colgroup>

          <thead>
            <tr>
              <th class="occ-name"></th>
              <% %w[月 火 水 木 金 土 日].each_with_index do |w, i| %>
                <% weekend_class = (i == 5 ? "is-sat" : (i == 6 ? "is-sun" : "")) %>
                <th class="weekday <%= weekend_class %>"><%= w %></th>
              <% end %>
            </tr>
          </thead>

          <tbody>
            <% @weeks.each do |week| %>

              <tr class="week-head-row">
                <td class="occ-name"></td>
                <% week.each_with_index do |date, i| %>
                  <% in_month = (date.month == @shift_month.month) %>
                  <% weekend_class = (i == 5 ? "is-sat" : (i == 6 ? "is-sun" : "")) %>
                  <% holiday = @holiday_by_date[date] %>
                  <% is_holiday = holiday.present? %>

                  <td class="day-head <%= weekend_class %> <%= in_month ? "" : "is-out" %> <%= "is-holiday" if is_holiday %>">
                    <div class="day-date <%= 'is-holiday' if is_holiday %>">
                      <%= date.month %>月<%= date.day %>日
                      <% if is_holiday %>
                        <span class="holiday-name"><%= holiday.name %></span>
                      <% end %>
                    </div>

                    <div class="day-kinds">
                      <div class="kcell">日勤</div>
                      <div class="kcell">夜勤</div>
                      <div class="kcell">宿直</div>
                    </div>
                  </td>
                <% end %>
              </tr>

              <% @occupation_order.each do |occupation| %>
                <tr class="<%= occupation[:row_class] %>">
                  <th class="occ-name"><%= occupation[:label] %></th>

                  <% week.each do |date| %>
                    <% in_month = (date.month == @shift_month.month) %>
                    <td class="day-cell <%= in_month ? "" : "is-out" %>">

                      <div class="day-slots">
                        <div class="slot slot-day"    data-shift-kind="day">
                          <% requests = @holiday_requests_by_date[date] || [] %>
                          <% requests.each do |request| %>
                            <% if row_key_for(request.staff) == occupation[:key] %>
                              <div class="holiday-in-slot"><%= "#{request.staff.last_name} 休" %></div>
                            <% end %>
                          <% end %>
                        </div>
                        <div class="slot slot-night"  data-shift-kind="night"></div>
                        <div class="slot slot-stay"   data-shift-kind="stay"></div>
                      </div>
                    </td>
                  <% end %>  
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <div id="right-sidebar-col" class="col-md-2 col-lg-2 p-0 bg-light border-start">
      <%= render "shift_months/right_sidebar" %>
    </div>
  </div>
</div>
