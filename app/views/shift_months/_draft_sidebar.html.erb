<div class="p-2">
  <div class="fw-bold mb-2">職員状況</div>

  <table class="table table-sm staff-stats-table">
    <thead>
      <tr>
        <th>職員</th>
        <th>日勤</th>
        <th>早番</th>
        <th>遅番</th>
        <th>夜勤</th>
        <th>休日</th>
      </tr>
    </thead>
    <tbody>
      <% sorted_rows =
          stats_rows
            .select { |row| ( s = row[:staff]) && s.active? } 
            .sort_by { |row| row[:staff].workday_constraint == "free" ? 0 : 1 }
      %>
      <% sorted_rows.each do |row| %>
        <tr class="<%= row[:staff].workday_constraint == 'fixed' ? 'fixed-staff-row' : '' %>">
          <% weekly_shortage = row[:weekly_shortage] %>
          <% weekly_weeks = Array(row[:weekly_shortage_weeks]) %>

          <td class="<%= weekly_shortage ? 'bg-danger-subtle text-danger' : '' %>"
              title="<%= weekly_shortage ? "週勤務が満たせていない週があります（不足: #{weekly_weeks.map { |n| "第#{n}週" }.join('、')}）" : '' %>">
            <%= row[:staff].last_name %> <%= row[:staff].first_name %>
          </td>
          <td><%= row[:day] %></td>
          <td><%= row[:early] %></td>
          <td><%= row[:late] %></td>
          <td><%= row[:night] %></td>
          <td class="<%= row[:holiday_shortage] ? 'bg-danger-subtle text-danger fw-bold' : '' %>">
            <%= row[:holiday] %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>