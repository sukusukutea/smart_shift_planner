<div class="container-fluid">
  <div class="row min-vh-100">
    <div class="col-md-3 col-lg-2 p-0" style="background-color:#e6f0f0;">
      <%= render "layouts/sidebar" %>
    </div>

    <div class="col-md-9 col-lg-10 py-4">
      <div class="mx-auto" style="width: 90%; min-width: 700px;">

        <div class="d-flex align-items-center mb-5">
          <h1 class="h4 fw-bold mb-0 me-3">職員一覧</h1>
          <%= link_to "+職員新規登録", new_staff_path, class: "btn btn-secondary btn-sm py-1 px-2" %>
        </div>

        <table class="table table-sm table-bordered align-middle">
          <thead>
            <tr class="text-center">
              <th style="width: 100px; background-color: #e6f0f0;">操作</th>
              <th style="width: 130px; background-color: #e6f0f0;">スタッフ名</th>
              <th style="width: 100px; background-color: #e6f0f0;">職種</th>
              <th style="width: 100px; background-color: #e6f0f0;">出勤日</th>
              <th style="background-color: #e6f0f0;">日勤</th>
              <th style="background-color: #e6f0f0;">早番</th>
              <th style="background-color: #e6f0f0;">遅番</th>
              <th style="background-color: #e6f0f0;">夜勤</th>
              <th style="background-color: #e6f0f0;">訪問</th>
              <th style="background-color: #e6f0f0;">運転</th>
              <th style="background-color: #e6f0f0;">調理</th>
              <th style="width: 120px; background-color: #e6f0f0;">日勤表示</th>
            </tr>
          </thead>

          <tbody class="text-center">
            <% if @staffs.any? %>
              <% @staffs.each do |staff| %>
                <% used = @used_staff_ids&.include?(staff.id) %>

                <tr>
                  <td class= "text-center">
                    <div class="d-inline-flex align-items-center gap-1">                    
                      <%= button_to "編集", 
                                  edit_staff_path(staff),
                                  method: :get,
                                  class: "btn btn-outline-secondary btn-sm px-1 py-0",
                                  form_class: "d-inline m-0" %>

                      <% if staff.active? %>
                        <% if used %>
                          <%= button_to "退職",
                                        staff_path(staff),
                                        method: :delete,
                                        form: { data: { turbo_confirm: "過去のシフトは残したまま、退職（無効化）にします。よろしいですか？" } },
                                        class: "btn btn-outline-danger btn-sm px-1 py-0",
                                        form_class: "d-inline m-0" %>
                        <% else %>
                          <%= button_to "削除",
                                        staff_path(staff),
                                        method: :delete,
                                        form: { data: { turbo_confirm: "この職員はまだシフトに使用されていません。削除しますか？" } },
                                        class: "btn btn-outline-danger btn-sm px-1 py-0",
                                        form_class: "d-inline m-0" %>
                        <% end %>
                      <% else %>
                        <%= button_to "復職",
                                      restore_staff_path(staff),
                                      method: :patch,
                                      form: { data: {turbo_confirm: "この職員を復職させますか？" } },
                                      class: "btn btn-outline-success btn-sm px-1 py-0",
                                      form_class: "d-inline m-0" %>
                      <% end %>
                    </div>
                  </td>

                  <td>
                    <%= "#{staff.last_name} #{staff.first_name}" %>
                    <% unless staff.active %>
                      <span class="badge text-bg-secondary ms-1">退職</span>
                    <% end %>
                  </td>
                  <td><%= staff.occupation&.name || "未設定" %></td>
                  <td class="text-center small" style="white-space: nowrap;">
                    <% wdays = %w[月 火 水 木 金 土 日] %>

                    <% if staff.workday_constraint == "free" %>
                      <% ng = staff.staff_unworkable_wdays.map(&:wday).sort %>
                      <span class="text-muted">
                        -
                        <% if ng.any? %>
                          <span class="small text-muted">
                          ❎<%= ng.map { |i| "#{wdays[i]}" }.join %>
                          </span>
                        <% end %>
                      </span>
                    <% elsif staff.workday_constraint == "weekly" %>
                      <% ng = staff.staff_unworkable_wdays.map(&:wday).sort %>

                      <span class="small">
                        週<%= staff.weekly_workdays %>日
                      </span>

                      <% if ng.any? %>
                        <span class="small text-muted">
                          ❎<%= ng.map { |i| wdays[i] }.join %>
                        </span>
                      <% end %>

                    <% else %>
                      <% selected = staff.staff_workable_wdays.map(&:wday).sort %>
                      <span><%= selected.map { |i| wdays[i] }.join %></span> 
                    <% end %>
                  </td>

                  <td><%= staff.can_day   ? "○" : "-" %></td>
                  <td><%= staff.can_early ? "○" : "-" %></td>
                  <td><%= staff.can_late  ? "○" : "-" %></td>
                  <td><%= staff.can_night ? "○" : "-" %></td>

                  <td><%= staff.can_visit ? "○" : "-" %></td>
                  <td><%= staff.can_drive ? "○" : "-" %></td>
                  <td><%= staff.can_cook  ? "○" : "-" %></td>
                  <td class="text-start small" style="white-space: nowrap;">
                    <% opts = staff.staff_day_time_options.sort_by { |o| [o.position.to_i, o.id.to_i] } %>

                    <% if opts.any? %>
                      <% opts.each do |opt| %>
                        <div class="<%= opt.active ? '' : 'text-muted' %>">
                          <%= staff.last_name %><%= opt.time_text.present? ? "(#{opt.time_text})" : "" %>

                          <% if opt.is_default %>
                            <span class="me-1">✓</span>
                          <% end %>
                        </div>
                      <% end %>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  職員が登録されていません。「+職員新規登録」から登録してください。
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
